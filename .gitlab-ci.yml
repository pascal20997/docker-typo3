image: docker:stable

stages:
  - build
  - test
  - release

# When using dind, it's wise to use the overlayfs driver for
# improved performance.
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_REGISTRY: docker-registry.crynton.com
  CONTAINER_TEST_IMAGE: docker-registry.crynton.com/docker/typo3:$CI_COMMIT_REF_SLUG
  CONTAINER_RELEASE_IMAGE: docker-registry.crynton.com/docker/typo3

services:
  - docker:dind

before_script:
  - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $DOCKER_REGISTRY 

build:
  stage: build
  script:
    - docker build -t $CONTAINER_TEST_IMAGE .
    - docker push $CONTAINER_TEST_IMAGE

# todo: add better tests
test-php:
  stage: test
  script:
    - docker pull $CONTAINER_TEST_IMAGE
    - docker run $CONTAINER_TEST_IMAGE php -v

test-composer:
  stage: test
  script:
    - docker pull $CONTAINER_TEST_IMAGE
    - docker run $CONTAINER_TEST_IMAGE composer -V

test-imagemagick:
  stage: test
  script:
    - docker pull $CONTAINER_TEST_IMAGE
    - docker run $CONTAINER_TEST_IMAGE convert -version

release-latest:
  stage: release
  script:
    - docker pull $CONTAINER_TEST_IMAGE
    - docker tag $CONTAINER_TEST_IMAGE $CONTAINER_RELEASE_IMAGE
    - docker push $CONTAINER_RELEASE_IMAGE:latest

release-tagged:
  stage: release
  script:
    - docker pull $CONTAINER_RELEASE_IMAGE:latest
    - docker push $CONTAINER_RELEASE_IMAGE:$CI_COMMIT_REF_SLUG
  only:
    - branches
    - tags
  except:
    - master

# Automated docker build will be fired after push!
push-on-github:
  image: buildpack-deps:latest
  stage: release
  # we donÂ´t need docker login for this
  before_script: []
  script:
    - mkdir -p ~/.ssh
    - echo "$DEPLOY_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan github.com >> ~/.ssh/known_hosts
    - git config --global user.name "Crynton Runner"
    - git config --global user.email "info@crynton.com"
    - git fetch --prune
    - git push --prune git@github.com:pascal20997/docker-typo3.git +refs/remotes/origin/*:refs/heads/* +refs/tags/*:refs/tags/*
